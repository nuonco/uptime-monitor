#:schema https://api.nuon.co/v1/general/config-schema?type=action
name    = "headlamp_token"
timeout = "1m"

[[triggers]]
type           = "post-deploy-component"
component_name = "headlamp"

[[triggers]]
type = "manual"

[[steps]]
name = "create"
inline_contents = """
#!/usr/bin/env sh
set -e

echo "[headlamp-token] Creating service account and token for Headlamp"

# Create the service account if it doesn't exist
kubectl create serviceaccount headlamp-admin -n default --dry-run=client -o yaml | kubectl apply -f -

# Create cluster role binding for admin access
cat <<EOF | kubectl apply -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: headlamp-admin
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: headlamp-admin
  namespace: default
EOF

# Generate a long-lived token (1 year)
TOKEN=$(kubectl create token headlamp-admin -n default --duration=8760h)

echo "[headlamp-token] Token created successfully"

# Output for Nuon - write JSON to the output file
echo "{\"token\": \"$TOKEN\"}" >> $NUON_ACTIONS_OUTPUT_FILEPATH
"""
